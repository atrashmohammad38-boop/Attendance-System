<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amjad Baalbeck - Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #1565C0;
            --light-blue: #E3F2FD;
            --accent-yellow: #FFD600;
            --dark-yellow: #FFC400;
            --dark-text: #212121;
            --light-text: #757575;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            color: var(--dark-text);
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(to right, var(--primary-blue), #0D47A1);
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 2.5rem;
            margin: 0;
        }
        
        .logo-accent {
            color: var(--accent-yellow);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            transition: transform 0.3s;
            margin-bottom: 20px;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(to right, var(--primary-blue), #1976D2);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
            padding: 15px 20px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .btn-primary {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        
        .btn-primary:hover {
            background-color: #0D47A1;
            border-color: #0D47A1;
        }
        
        .btn-warning {
            background-color: var(--accent-yellow);
            border-color: var(--accent-yellow);
            color: var(--dark-text);
        }
        
        .btn-warning:hover {
            background-color: var(--dark-yellow);
            border-color: var(--dark-yellow);
        }
        
        .stats-box {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .stats-box i {
            font-size: 2.5rem;
            color: var(--primary-blue);
            margin-bottom: 15px;
        }
        
        .stats-box .number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin: 10px 0;
        }
        
        .stats-box .label {
            color: var(--light-text);
            font-size: 1rem;
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .attendance-table th {
            background-color: var(--light-blue);
            color: var(--primary-blue);
            padding: 12px;
            text-align: left;
        }
        
        .attendance-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .attendance-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .badge {
            padding: 6px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .badge-present {
            background-color: #4CAF50;
            color: white;
        }
        
        .badge-absent {
            background-color: #F44336;
            color: white;
        }
        
        .badge-late {
            background-color: #FF9800;
            color: white;
        }
        
        .notification-badge {
            background-color: var(--accent-yellow);
            color: var(--dark-text);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .user-role {
            background-color: var(--accent-yellow);
            color: var(--dark-text);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .notification-item {
            border-left: 3px solid var(--primary-blue);
            padding-left: 15px;
            margin-bottom: 15px;
        }
        
        .notification-time {
            font-size: 0.8rem;
            color: var(--light-text);
        }
        
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .role-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--primary-blue);
        }
        
        .role-option {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .role-option.active {
            background: var(--primary-blue);
            color: white;
        }
        
        .dashboard-section {
            display: none;
        }
        
        .dashboard-section.active {
            display: block;
        }
        
        .nav-tabs {
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--light-text);
            font-weight: 600;
            padding: 12px 20px;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-blue);
            border-bottom: 3px solid var(--primary-blue);
            background: transparent;
        }
        
        /* Loading spinner */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        /* Toast notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        @media (max-width: 768px) {
            .stats-box .number {
                font-size: 1.8rem;
            }
            
            .header {
                padding: 15px;
            }
            
            .logo-text {
                font-size: 2rem;
            }
            
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast container for notifications -->
    <div class="toast-container"></div>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="container">
            <div class="login-container">
                <div class="login-logo">
                    <h2 class="logo-text">AMJAD BAALBECK <span class="logo-accent">ATTENDANCE</span></h2>
                    <p class="text-muted">Please log in to continue</p>
                </div>
                
                <div class="role-selector">
                    <div class="role-option active" data-role="manager">Manager</div>
                    <div class="role-option" data-role="supervisor">Supervisor</div>
                    <div class="role-option" data-role="teacher">Teacher</div>
                </div>
                
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Email</label>
                        <input type="email" class="form-control" id="username" required placeholder="name@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="loginButton">
                        <span class="login-text">Login</span>
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    </button>
                    <div class="alert alert-danger mt-3" role="alert" id="loginError" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application (initially hidden) -->
    <div id="appScreen" style="display: none;">
        <div class="container">
            <div class="header">
                <h1 class="logo-text">AMJAD BAALBECK <span class="logo-accent">ATTENDANCE SYSTEM</span></h1>
                <p class="subtitle">Track and manage attendance for students, teachers, and staff</p>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Dashboard</h2>
                <span class="user-role" id="dashboardRole">Manager</span>
            </div>
            
            <!-- Stats Row -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stats-box">
                        <i class="fas fa-users"></i>
                        <div class="number" id="totalStudents">0</div>
                        <div class="label">Total Students</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-box">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <div class="number" id="totalTeachers">0</div>
                        <div class="label">Total Teachers</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-box">
                        <i class="fas fa-user-check"></i>
                        <div class="number" id="attendanceRate">0%</div>
                        <div class="label">Today's Attendance</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-box">
                        <i class="fas fa-clock"></i>
                        <div class="number" id="lateToday">0</div>
                        <div class="label">Late Today</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <!-- Attendance Card -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Today's Attendance</span>
                            <div>
                                <button class="btn btn-sm btn-light" id="printBtn">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="btn btn-sm btn-light" id="downloadBtn">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="attendance-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Role</th>
                                            <th>Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceTableBody">
                                        <!-- Attendance data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecordModal">
                                        <i class="fas fa-plus"></i> Add Record
                                    </button>
                                    <button class="btn btn-warning">
                                        <i class="fas fa-paper-plane"></i> Send Notifications
                                    </button>
                                </div>
                                <button class="btn btn-outline-primary" id="viewAllBtn">
                                    View All <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Recent Activity -->
                    <div class="card mb-4">
                        <div class="card-header">
                            Recent Activity
                        </div>
                        <div class="card-body" id="recentActivity">
                            <!-- Recent activity will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            Quick Actions
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary text-start" data-section="attendance">
                                    <i class="fas fa-calendar-check me-2"></i> Take Attendance
                                </button>
                                <button class="btn btn-outline-primary text-start" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                                    <i class="fas fa-user-plus me-2"></i> Add New Student
                                </button>
                                <button class="btn btn-outline-primary text-start" data-bs-toggle="modal" data-bs-target="#addTeacherModal">
                                    <i class="fas fa-chalkboard-teacher me-2"></i> Add New Teacher
                                </button>
                                <button class="btn btn-outline-primary text-start" id="exportBtn">
                                    <i class="fas fa-file-export me-2"></i> Export Reports
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notifications Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            Send Notifications
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="fas fa-envelope fa-2x text-primary mb-3"></i>
                                            <h5>Email Notifications</h5>
                                            <p class="small">Send absence/late notifications via email</p>
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#emailModal">
                                                <i class="fas fa-paper-plane"></i> Send Email
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="fas fa-sms fa-2x text-primary mb-3"></i>
                                            <h5>SMS Notifications</h5>
                                            <p class="small">Send absence/late notifications via SMS</p>
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#smsModal">
                                                <i class="fas fa-paper-plane"></i> Send SMS
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Record Modal -->
    <div class="modal fade" id="addRecordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Attendance Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Person</label>
                        <select class="form-select" id="recordPerson">
                            <option value="">Select a person</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="recordStatus">
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="recordTime">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveRecordBtn">Save Record</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="studentName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Class</label>
                        <input type="text" class="form-control" id="studentClass">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="studentPhone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="studentEmail">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveStudentBtn">Save Student</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Teacher Modal -->
    <div class="modal fade" id="addTeacherModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Teacher</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="teacherName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-control" id="teacherSubject">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="teacherPhone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="teacherEmail">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTeacherBtn">Save Teacher</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Email Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Email Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Recipients</label>
                        <select class="form-select">
                            <option>All Absent Today</option>
                            <option>All Late Today</option>
                            <option>All Students</option>
                            <option>All Teachers</option>
                            <option>Custom Selection</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-control" value="Attendance Notification">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" rows="5">Dear Parent/Guardian,

This is to inform you that your child was absent/late today.

Please contact the school for more information.

Regards,
Amjad Baalbeck Administration
                        </textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary">Send Email</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SMS Modal -->
    <div class="modal fade" id="smsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send SMS Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Recipients</label>
                        <select class="form-select">
                            <option>All Absent Today</option>
                            <option>All Late Today</option>
                            <option>All Students</option>
                            <option>All Teachers</option>
                            <option>Custom Selection</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" rows="3" maxlength="160">Dear Parent, your child was absent/late today. Please contact the school for details.</textarea>
                        <div class="form-text">160 characters maximum</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary">Send SMS</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDKs + App Logic -->
    <script type="module">
        // Firebase imports (v12 modules)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import {
            getFirestore, collection, addDoc, getDocs, getDoc, doc,
            query, where, orderBy, serverTimestamp, limit
        } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // Your Firebase config (from your project amjad-attendance-6)
        const firebaseConfig = {
            apiKey: "AIzaSyCRKlsEn4KhSmcIvo2N_YH9SDXjYS6DGi0",
            authDomain: "amjad-attendance-6.firebaseapp.com",
            projectId: "amjad-attendance-6",
            storageBucket: "amjad-attendance-6.firebasestorage.app",
            messagingSenderId: "820031615244",
            appId: "1:820031615244:web:c38056902e3bd8b2e91929",
            measurementId: "G-0Z15NYG3DL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        try { getAnalytics(app); } catch(e) { /* analytics may require https */ }
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ===== Helpers =====
        function yyyymmddLocal(date = new Date()) {
            const tzoffset = date.getTimezoneOffset() * 60000;
            const localISO = new Date(date - tzoffset).toISOString().slice(0, 10);
            return localISO;
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.id = toastId;
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Role selection pills
        const roleOptions = document.querySelectorAll('.role-option');
        roleOptions.forEach(option => {
            option.addEventListener('click', function() {
                roleOptions.forEach(o => o.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // ===== Auth & Login =====
        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        const loginText = loginButton.querySelector('.login-text');
        const loginSpinner = loginButton.querySelector('.spinner-border-sm');
        const loginError = document.getElementById('loginError');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = (document.getElementById('username').value || '').trim();
            const password = document.getElementById('password').value;
            const selectedRole = document.querySelector('.role-option.active').getAttribute('data-role');

            if (!email || !password) return;

            loginText.style.display = 'none';
            loginSpinner.style.display = 'inline-block';
            loginError.style.display = 'none';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Show app
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'block';
                document.getElementById('dashboardRole').textContent = selectedRole.charAt(0).toUpperCase() + selectedRole.slice(1);
                showToast('Login successful!');
                await loadAllData();
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = error.message;
                loginError.style.display = 'block';
            } finally {
                loginText.style.display = 'inline-block';
                loginSpinner.style.display = 'none';
            }
        });

        // Keep UI if already logged in
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'block';
                await loadAllData();
            } else {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('appScreen').style.display = 'none';
            }
        });

        // ===== Firestore Data Loaders =====
        async function loadAllData() {
            await Promise.all([
                loadCountsAndTodayAttendance(),
                populatePeopleOptions(),
                loadRecentActivity()
            ]);
        }

        async function loadCountsAndTodayAttendance() {
            try {
                const [studentsSnap, teachersSnap] = await Promise.all([
                    getDocs(collection(db, 'students')),
                    getDocs(collection(db, 'teachers'))
                ]);

                // Counts
                const totalStudents = studentsSnap.size;
                const totalTeachers = teachersSnap.size;
                document.getElementById('totalStudents').textContent = totalStudents;
                document.getElementById('totalTeachers').textContent = totalTeachers;

                // Today's attendance
                const today = yyyymmddLocal();
                const attendanceQ = query(
                    collection(db, 'attendance'),
                    where('date', '==', today),
                    orderBy('timestamp', 'desc')
                );
                const attendanceSnap = await getDocs(attendanceQ);

                let presentCount = 0;
                let lateCount = 0;
                const tbody = document.getElementById('attendanceTableBody');
                tbody.innerHTML = '';

                attendanceSnap.forEach((docSnap) => {
                    const data = docSnap.data();
                    const status = data.status || 'absent';
                    if (status === 'present') presentCount++;
                    if (status === 'late') lateCount++;

                    const badgeClass = status === 'present' ? 'badge-present' : status === 'late' ? 'badge-late' : 'badge-absent';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${data.name || '-'}</td>
                        <td>${data.role || '-'}</td>
                        <td>${data.time || '-'}</td>
                        <td><span class="badge ${badgeClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" title="Edit (not implemented)">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                const totalPeople = totalStudents + totalTeachers;
                const attendanceRate = totalPeople > 0 ? Math.round((presentCount / totalPeople) * 100) : 0;
                document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
                document.getElementById('lateToday').textContent = lateCount;
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Error loading data', 'danger');
            }
        }

        async function populatePeopleOptions() {
            const select = document.getElementById('recordPerson');
            select.innerHTML = '<option value="">Select a person</option>';

            const [studentsSnap, teachersSnap] = await Promise.all([
                getDocs(collection(db, 'students')),
                getDocs(collection(db, 'teachers'))
            ]);

            studentsSnap.forEach((d) => {
                const s = d.data();
                const opt = document.createElement('option');
                opt.value = `students:${d.id}`;
                opt.textContent = `${s.name} (Student${s.class ? ' - ' + s.class : ''})`;
                select.appendChild(opt);
            });

            teachersSnap.forEach((d) => {
                const t = d.data();
                const opt = document.createElement('option');
                opt.value = `teachers:${d.id}`;
                opt.textContent = `${t.name} (Teacher${t.subject ? ' - ' + t.subject : ''})`;
                select.appendChild(opt);
            });
        }

        async function loadRecentActivity() {
            try {
                const today = yyyymmddLocal();
                const qy = query(
                    collection(db, 'attendance'),
                    where('date', '==', today),
                    orderBy('timestamp', 'desc'),
                    limit(8)
                );
                const snap = await getDocs(qy);
                const container = document.getElementById('recentActivity');
                container.innerHTML = '';
                if (snap.empty) {
                    container.innerHTML = '<p class="text-muted mb-0">No activity yet today.</p>';
                    return;
                }
                snap.forEach((d) => {
                    const a = d.data();
                    const div = document.createElement('div');
                    div.className = 'notification-item';
                    div.innerHTML = `
                        <div><strong>${a.name || 'Unknown'}</strong> marked <strong>${(a.status || '').toUpperCase()}</strong></div>
                        <div class="notification-time">${a.time || ''}</div>
                    `;
                    container.appendChild(div);
                });
            } catch (e) {
                console.error(e);
            }
        }

        // ===== Actions: Save Attendance / Add Student / Add Teacher =====
        document.getElementById('saveRecordBtn').addEventListener('click', async () => {
            const value = document.getElementById('recordPerson').value;
            const status = document.getElementById('recordStatus').value;
            const time = document.getElementById('recordTime').value;
            if (!value) {
                showToast('Please select a person', 'danger');
                return;
            }
            const [collectionName, id] = value.split(':');
            try {
                const ref = doc(db, collectionName, id);
                const snap = await getDoc(ref);
                if (!snap.exists()) {
                    showToast('Selected person not found', 'danger');
                    return;
                }
                const data = snap.data();
                const today = yyyymmddLocal();
                await addDoc(collection(db, 'attendance'), {
                    personId: id,
                    personType: collectionName === 'students' ? 'student' : 'teacher',
                    name: data.name || '',
                    role: collectionName === 'students' ? 'Student' : 'Teacher',
                    status,
                    time: time || new Date().toLocaleTimeString(),
                    date: today,
                    timestamp: serverTimestamp()
                });
                showToast('Attendance record saved successfully');
                bootstrap.Modal.getInstance(document.getElementById('addRecordModal')).hide();
                await loadAllData();
            } catch (error) {
                console.error('Error saving record:', error);
                showToast('Error saving record', 'danger');
            }
        });

        document.getElementById('saveStudentBtn').addEventListener('click', async () => {
            const name = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            if (!name || !studentClass) {
                showToast('Please fill in all required fields', 'danger');
                return;
            }
            try {
                await addDoc(collection(db, 'students'), {
                    name, class: studentClass, phone, email, createdAt: serverTimestamp()
                });
                showToast('Student added successfully');
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                await loadAllData();
            } catch (error) {
                console.error('Error adding student:', error);
                showToast('Error adding student', 'danger');
            }
        });

        document.getElementById('saveTeacherBtn').addEventListener('click', async () => {
            const name = document.getElementById('teacherName').value.trim();
            const subject = document.getElementById('teacherSubject').value.trim();
            const phone = document.getElementById('teacherPhone').value.trim();
            const email = document.getElementById('teacherEmail').value.trim();
            if (!name || !subject) {
                showToast('Please fill in all required fields', 'danger');
                return;
            }
            try {
                await addDoc(collection(db, 'teachers'), {
                    name, subject, phone, email, createdAt: serverTimestamp()
                });
                showToast('Teacher added successfully');
                bootstrap.Modal.getInstance(document.getElementById('addTeacherModal')).hide();
                await loadAllData();
            } catch (error) {
                console.error('Error adding teacher:', error);
                showToast('Error adding teacher', 'danger');
            }
        });

        // ===== Simple Export/Print Hooks =====
        document.getElementById('printBtn').addEventListener('click', () => window.print());
        document.getElementById('downloadBtn').addEventListener('click', () => {
            // Simple CSV export for today's attendance
            const rows = [['Name','Role','Time','Status']];
            document.querySelectorAll('#attendanceTableBody tr').forEach(tr => {
                const cells = Array.from(tr.querySelectorAll('td')).map(td => td.innerText.replace(/,/g, ' '));
                rows.push([cells[0], cells[1], cells[2], cells[3]]);
            });
            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `attendance_${yyyymmddLocal()}.csv`; 
            a.click();
        });

        document.getElementById('viewAllBtn').addEventListener('click', () => {
            showToast('View All not implemented in demo', 'danger');
        });
    </script>
</body>
</html>
